import React, { useEffect, useMemo, useCallback, useLayoutEffect, Fragment, useState } from 'react';
import { Form, Button, Row, Col } from 'antd';
import { Data, FormControlInputId } from './types';
import SlotContent from './SlotContent';
import { getLabelCol, isObject } from './utils';
import { slotInputIds, inputIds, outputIds } from './constants';

type FormControlInputRels = {
  validate: (val?: any) => {
    returnValidate: (val) => {};
  };
  getValue: (val?: any) => {
    returnValue: (val) => {};
  };
  [key: string]: (val?: any) => void;
};

export default function Runtime(props: RuntimeParams<Data>) {
  const { data, env, outputs, inputs, slots, _inputs } = props;
  const [formRef] = Form.useForm();

  const childrenInputs = useMemo<{
    [id: string]: {
      [key in FormControlInputId]: FormControlInputRels[key];
    };
  }>(() => {
    return {};
  }, [env.edit]);

  useLayoutEffect(() => {
    inputs[inputIds.SET_FIELDS_VALUE]((val) => {
      // resetFields();

      setFieldsValue(val);
      slots['content'].inputs[slotInputIds.SET_FIELDS_VALUE](val);
    });

    inputs[inputIds.SET_INITIAL_VALUES]((val) => {
      setInitialValues(val);
      slots['content'].inputs[slotInputIds.SET_FIELDS_VALUE](val);
    });

    inputs['resetFields']((val, outputRels) => {
      resetFields();
      outputRels['onResetFinish']();
    });

    inputs[inputIds.SUBMIT]((val, outputRels) => {
      submit(outputRels);
    });

    inputs[inputIds.SUBMIT_AND_MERGE]((val, outputRels) => {
      if (isObject(val)) {
        submitMethod(outputIds.ON_MERGE_FINISH, outputRels, val);
      } else {
        submitMethod(outputIds.ON_MERGE_FINISH, outputRels);
      }
    });

    //------ For 表单项私有 ---------
    _inputs['validate']((val, outputRels) => {
      validate().then((r) => {
        outputRels['returnValidate']({
          validateStatus: 'success'
        });
      });
    });

    _inputs['getValue']((val, outputRels) => {
      getValue().then((v) => {
        outputRels['returnValue'](v);
      });
    });

    _inputs['setValue']((val) => {
      setFieldsValue(val);
    });

    // slots['content']._inputs['validateTrigger'](id=>{
    //   const item = data.items.find(item => item.id === id)

    //   console.log('validateTrigger', item)
    // });
  }, []);

  const setFieldsValue = (val) => {
    if (val) {
      Object.keys(val).forEach((key) => {
        const item = data.items.find((item) => item.name === key);
        if (item) {
          const input = childrenInputs[item.id];
          if (isObject(val[key])) {
            input?.setValue({ ...val[key] });
          } else {
            input?.setValue(val[key]);
          }
        }
      });
    }
  };

  const setInitialValues = (val) => {
    if (val) {
      Object.keys(val).forEach((key) => {
        const item = data.items.find((item) => item.name === key);
        if (item) {
          const input = childrenInputs[item.id];
          if (isObject(val[key])) {
            input?.setInitialValue({ ...val[key] });
          } else {
            input?.setInitialValue(val[key]);
          }
        }
      });
    }
  };

  const resetFields = () => {
    data.items.forEach((item) => {
      const id = item.id;
      const input = childrenInputs[id];
      input?.resetValue();
    });
  };

  const validate = useCallback(() => {
    return new Promise((resolve, reject) => {
      Promise.all(
        data.items.map((item) => {
          if (!data.submitHiddenFields) {
            // 隐藏的表单项，不再校验
            if (!item.visible) return { validateStatus: 'success' };
          }

          const id = item.id;
          const input = childrenInputs[id];

          return new Promise((resolve, reject) => {
            input?.validate({ ...item }).returnValidate((validateInfo) => {
              //调用所有表单项的校验
              item.validateStatus = validateInfo?.validateStatus;
              item.help = validateInfo?.help;
              resolve(validateInfo);
            });
          });
        })
      )
        .then((values) => {
          let rtn = false;
          values.forEach((item) => {
            if (item.validateStatus !== 'success') {
              reject(item);
            }
          });

          resolve(rtn);
        })
        .catch((e) => reject(e));
    });
  }, []);

  const getValue = useCallback(() => {
    return new Promise((resolve, reject) => {
      /** 隐藏的表单项，不收集数据 **/
      const formItems = data.submitHiddenFields
        ? data.items
        : data.items.filter((item) => item.visible);

      Promise.all(
        formItems.map((item) => {
          const id = item.id;
          const input = childrenInputs[id];

          return new Promise((resolve, reject) => {
            let count = 0;
            let value = {};
            input?.getValue().returnValue((val, key) => {
              //调用所有表单项的 getValue/returnValue
              if (typeof data.fieldsLength !== 'undefined') {
                value[key] = {
                  name: item.name,
                  value: val
                };
                count++;
                if (count == data.fieldsLength) {
                  resolve(value);
                }
              } else {
                value = {
                  name: item.name,
                  value: val
                };
                console.log(value);

                resolve(value);
              }
            });
          });
        })
      )
        .then((values) => {
          if (data.dataType === 'list') {
            const arr = [];
            values.forEach((valItem) => {
              Object.keys(valItem).map((key) => {
                if (!arr[key]) {
                  arr[key] = {};
                }
                arr[key][valItem[key].name] = valItem[key].value;
              });
            });
            resolve(arr);
          } else {
            const rtn = {};
            values.forEach((item) => {
              rtn[item.name] = item.value;
            });
            resolve(rtn);
          }
        })
        .catch((e) => reject(e));
    });
  }, []);

  const submit = (outputRels?: any) => {
    submitMethod(outputIds.ON_FINISH, outputRels);
  };

  const submitMethod = (outputId: string, outputRels?: any, params?: any) => {
    validate()
      .then(() => {
        getValue()
          .then((values: any) => {
            const res = { ...values, ...params };
            if (outputRels) {
              outputRels[outputId](res);
            } else {
              outputs[outputId](res);
            }
          })
          .catch((e) => {
            console.log('收集表单项值失败', e);
          });
      })
      .catch((e) => {
        console.log('校验失败', e);
      });
  };

  return (
    <Fragment>
      {!data.isFormItem ? (
        <Form
          form={formRef}
          layout={data.layout}
          labelCol={data.layout === 'horizontal' ? getLabelCol(data) : undefined}
          // wrapperCol={{ span: 16 }}
        >
          <SlotContent
            env={env}
            slots={slots}
            data={data}
            childrenInputs={childrenInputs}
            outputs={outputs}
            submit={submitMethod}
          />
        </Form>
      ) : (
        <SlotContent env={env} slots={slots} data={data} childrenInputs={childrenInputs} />
      )}
    </Fragment>
  );
}

/**
 * @description 列表类型表单容器，暂不开放
 */
const FormListItem = ({ content, slots, env, isFormItem, data }) => {
  if (env.edit) {
    return content();
  }

  return (
    <Form.List name="item4">
      {(fields, { add, remove }) => {
        data.fieldsLength = fields.length;

        return (
          <>
            {fields.map((field, index) => {
              return <div key={field.key}>{content({ field })}</div>;
            })}
            {isFormItem ? (
              <Button
                onClick={() => {
                  add();
                }}
              >
                添加
              </Button>
            ) : (
              <Row style={{ flex: '1 1 100%' }} data-form-actions>
                <Col offset={8}>
                  <Form.Item>
                    <Button
                      onClick={() => {
                        add();
                      }}
                    >
                      添加
                    </Button>
                  </Form.Item>
                </Col>
              </Row>
            )}
          </>
        );
      }}
    </Form.List>
  );
};
